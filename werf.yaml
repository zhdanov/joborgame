project: {{ env "appname" }}
configVersion: 1
deploy:
  namespace: {{ env "appname" }}-{{ env "environment" }}
  namespaceSlug: false

---
image: {{ env "appname" }}-nginx
from: nginx:1.19.6-alpine

---
image: {{ env "appname" }}-php-fpm
from: php:7.4.14-fpm-alpine3.13
docker:
  USER: root
  WORKDIR: /var/www/html
  EXPOSE: "9000"
git:
- add: /
  to: /root/joborgame
  stageDependencies:
    install:
      - "**/*"
    setup:
      - "**/*"
ansible:
  beforeInstall:
  - name: install packages for php-fpm
    shell: apk add --no-cache libc-dev autoconf make gcc g++ bash vim zip libzip-dev libpng-dev openssh git php7-dev
  - name:  install php-extentions
    shell: |
      docker-php-ext-install gd zip bcmath pcntl
      pecl install mongodb
      docker-php-ext-enable mongodb
  - name: install php config
    shell: |
      cp /usr/local/etc/php/php.ini-production /usr/local/etc/php/php.ini
  - name:  ssh_config for gitlab
    shell: printf "Host gitlab-{{ env "environment" }}.gitlab-{{ env "environment" }}.svc.cluster.local\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> /etc/ssh/ssh_config

---
image: {{ env "appname" }}-mongodb
from: mongo:4.4.3-bionic
